<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=icon href=/logo.png><title>Secure Connection between AWS VPC and a Raspberry Pi | Tales of a technology enthusiast</title><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://rjourdan.com/pi-aws-vpc/cover.jpg"><meta name=twitter:title content="Secure Connection between AWS VPC and a Raspberry Pi"><meta name=twitter:description content="(Photo by Alina Grubnyak on Unsplash)
In a recent discussion with a colleague (in fact few months back, I have been slow on this one), they asked if I had a simple procedure to connect a Raspberry Pi running at home to a VPC on AWS."><meta property="og:title" content="Secure Connection between AWS VPC and a Raspberry Pi"><meta property="og:description" content="(Photo by Alina Grubnyak on Unsplash)
In a recent discussion with a colleague (in fact few months back, I have been slow on this one), they asked if I had a simple procedure to connect a Raspberry Pi running at home to a VPC on AWS."><meta property="og:type" content="article"><meta property="og:url" content="https://rjourdan.com/pi-aws-vpc/"><meta property="og:image" content="https://rjourdan.com/pi-aws-vpc/cover.jpg"><meta property="article:section" content><meta property="article:published_time" content="2021-04-30T11:01:07-05:00"><meta property="article:modified_time" content="2021-04-30T11:01:07-05:00"><link href=https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css rel=stylesheet integrity=sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.0.13/css/all.css integrity=sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp crossorigin=anonymous><link href="https://fonts.googleapis.com/css?family=Merriweather:300,300i,400,400i,700,700i" rel=stylesheet><link href=/css/medium.css rel=stylesheet><link href=/css/additional.css rel=stylesheet></head><body><nav class="navbar navbar-expand-sm navbar-light bg-white fixed-top mediumnavigation nav-down"><div class="container pr-0"><a class=navbar-brand href=https://rjourdan.com><img src=/logo.png alt=logo></a>
<button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarMediumish aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarMediumish><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=/me>About Me</a></li></ul></div><div class=navbar-social><a href=https://twitter.com/rjourdan_net><i class="fab fa-twitter social-icon" aria-hidden=true></i></a>
<a href=https://github.com/rjourdan><i class="fab fa-github social-icon" aria-hidden=true></i></a>
<a href=https://linkedin.com/in/rjourdan><i class="fab fa-linkedin social-icon" aria-hidden=true></i></a>
<a href=https://www.medium.com/@rjourdan><i class="fab fa-medium social-icon" aria-hidden=true></i></a></div></div></nav><div class=site-content><div class=container><div class=main-content><div class=container><div class=row><div class="col-md-2 pl-0"><div class="share sticky-top sticky-top-offset"><p>Share</p><ul><li class="ml-1 mr-1"><a target=_blank href="https://twitter.com/intent/tweet?text=Secure%20Connection%20between%20AWS%20VPC%20and%20a%20Raspberry%20Pi&url=https%3a%2f%2frjourdan.com%2fpi-aws-vpc%2f" onclick='return window.open(this.href,"twitter-share","width=550,height=435"),!1'><i class="fab fa-twitter"></i></a></li><li class="ml-1 mr-1"><a target=_blank href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2frjourdan.com%2fpi-aws-vpc%2f" onclick='return window.open(this.href,"LinkedIn-share","width=550,height=435"),!1'><i class="fab fa-linkedin-in"></i></a></li></ul><div class=sep></div><ul><li><a class="small smoothscroll" href=#disqus_thread></a></li></ul></div></div><div class="col-md-9 flex-first flex-md-unordered"><div class=mainheading><div class="row post-top-meta"><div class='d-none d-md-block' style=width:95px><img class=author-thumb src=/images/author.jpg alt="Romain Jourdan"></div><div class="col-xs-6 col-md-9 col-lg-10 text-center text-md-left md-nopad-left"><a target=_blank class=link-dark>Romain Jourdan</a><br><span class=author-description>Owner of this blog<br><i class="far fa-star"></i>
Apr 30, 2021
<i class="far fa-clock clock"></i>
9 min read</span></div></div><h1 class=posttitle>Secure Connection between AWS VPC and a Raspberry Pi</h1></div><div class=article-post><p><img src=cover.jpg alt="AWS Secure connection!"></p><p>(Photo by Alina Grubnyak on Unsplash)</p><p>In a recent discussion with a colleague (in fact few months back, I have been slow on this one), they asked if I had a simple procedure to connect a Raspberry Pi running at home to a VPC on AWS. By default, instances that you launch into an Amazon VPC can&rsquo;t communicate with your home network. In this case, they wanted to have on-prem workloads interacting with workloads in the cloud. I had no simple procedure to share and there are many solutions to address that problem. Here is a non-exhaustive list:</p><ul><li><strong>SD-WAN</strong>: There are several vendors that can address that use case easily. You probably don&rsquo;t want to buy a physical appliance so a virtual form factor would be the way to go. However running a SD-WAN VM on a Raspberry Pi might be challenging as they are usually designed to run on x86. Of course, if you have another server at home (ESX, KVM&mldr;), this would be feasible but probably a bit messy (you will have to play with routing). Look at Riverbed SteelConnect on the <a href=https://aws.amazon.com/marketplace/pp/Riverbed-Technology-Riverbed-SteelConnect-Gateway-/B0163DOLQ6>AWS marketplace</a> and <a href="https://www.youtube.com/watch?v=320jlA2z374">this video</a>.</li><li><strong>Site-to-Site VPN with a home router</strong>: Not all home routers will allow you to create VPN tunnels and very few have routing capabilities that will allow certain traffic to take the tunnel while the rest of your home network will directly breakout to the Internet. If you have a networking gear a bit more advanced like a Ubiquiti <a href="https://store.ui.com/products/unifi-security-gateway?variant=27264023809">Security Gateway</a> or <a href="https://store.ui.com/products/unifi-dream-machine?_pos=1&_sid=42df0ffeb&_ss=r">Dream Machine</a> (<a href=https://store.ui.com/>Pro</a> even better, that&rsquo;s what I have), then you can leverage this infrastructure to connect your Pi to AWS.</li><li><strong>Site-to-Site VPN from the Raspberry Pi</strong>: This sounds like the most straightforward solution. You probably don&rsquo;t need your full home network to connect to AWS, install a VPN client on the Pi and get it connected to your VPC.</li><li><strong>Alternate solutions like ZeroTier and Wiregard</strong>: There are cool alternatives to traditional VPN solutions that you may want to explore.</li></ul><p>For this exercise, I am going to run a simple container on Amazon ECS/Fargate and will call the API it presents from the Raspberry Pi. The container will be deployed in a private subnet in one of my AWS VPCs. It could be anything else like a EC2 instance for example.</p><p><img src=images/main_diagram.png alt="High-Level Diagram"></p><p>I set a static IP address on the Pi so it is easier to manage.
<code>sudo nano /etc/dhcpcd.conf</code></p><script type=application/javascript src=https://gist.github.com/rjourdan/63dfde3fc5a73f527658c276d87dab42.js></script><h2 id=building-the-aws-infrastructure>Building the AWS infrastructure</h2><p>In the following, I&rsquo;ll assume you have no VPC already built and we will do it together.
As always, there are multiple options to build our infrastructure on AWS: using the console, the AWS CLI, CloudFormation, Terraform&mldr; We are going to use the <a href=https://aws.amazon.com/cdk/>AWS Cloud Development Kit (CDK)</a> to build the various topologies.</p><h4 id=prerequisites><em>Prerequisites:</em></h4><ol><li><p>You need an <a href=https://aws.amazon.com/premiumsupport/knowledge-center/create-and-activate-aws-account/>AWS account</a> with a IAM User or <a href=https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_create_for-user.html>IAM Role</a> with an AdministratorAccess or AmazonVPCFullAccess</p></li><li><p>The AWS CLI allows you to interact with AWS services from a terminal session. Make sure you have the latest version of the AWS CLI installed on your system. (Download here for <a href=https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2-mac.html>Mac</a>, for <a href=https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2-windows.html>Windows</a> or for <a href=https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2-linux.html>Linux</a>)</p></li><li><p>We will use node.js in this example. You could use Python, Java or Typescript. It will be easier to follow along with node.js so I recommend you install it from <a href=https://nodejs.org/en/download/>nodejs.org</a>.</p></li><li><p>A text editor or IDE of your choice. I&rsquo;ll be using <a href=https://code.visualstudio.com/>VSCode</a>.</p></li><li><p>Install the AWS CDK toolkit from a terminal session <code>npm install -g aws-cdk</code></p></li><li><p>Install also the EC2 library that will use <code>npm install @aws-cdk/aws-ec2</code></p></li></ol><h4 id=initialize-the-project><em>Initialize the project:</em></h4><p>The first step will be to create a folder then initiate cdk and create the project structure:</p><p><code>mkdir cdk-aws-vpc-s2s-vpn && cd cdk-aws-vpc-s2s-vpn</code></p><p><code>cdk init --language typescript</code></p><p>The tool has generated several folders and file. Now we are going to bootstrap cdk and deploy a first time. Since we have not written any code yet, it will just create a CloudFormation bucket which will be used to store all the CloudFormation templates that CDK generates for you.</p><p>So now we are ready! I&rsquo;ll skip the SD-WAN solution for now (maybe for a future post), we will start by using our home router.</p><p><strong>Remark</strong>: I will not cover IPv6 in this article. It could be the topic of another one. Let me know if you are interested.</p><h2 id=site-to-site-vpn-with-ubiquiti-dream-machine-pro-udmp>Site-to-Site VPN with Ubiquiti Dream Machine Pro (UDMP)</h2><p>Although it is possible to deploy a VPN concentrator or a VPN capable router as a EC2 instance in a VPC, we are going to leverage the AWS Site-to-Site VPN service.</p><h3 id=building-the-aws-infrastructure-1>Building the AWS infrastructure</h3><p>The follow diagram depicts the infrastructure we are going to build.
<img src=images/s2s-udmp.png alt="Site-to-Site VPN Diagram"></p><p>Now edit the file <code>lib/cdk-aws-vpc-s2s-vpn-stack.ts</code> that was generated previously, and replace its content with the following then save.</p><script type=application/javascript src=https://gist.github.com/rjourdan/94e6481976da3ebc1bbd0c78f0ec8c4c.js></script><p>Let&rsquo;s deploy with <code>cdk deploy</code>! it will take few minutes to create the VPC, the public and private subnets as well as the Internet Gateway, NAT Gateway and all the VPN configuration.</p><p>Once the stack is created, go to your AWS console > VPC > Virtual Private Network (VPN) > Site-to-Site VPN Connections. Select the connection that has been created (it should be named with the name of your stack) and download the configuation. Depending on your router, you may found your vendor and platform. In the case of the UDMP, we will generate a generic configuration file.
<img src=images/genericConfig.png alt="Generic Config File"></p><p>Your browser will download a text file with all the information we will need to configure our UDMP. So now, go to your <a href=https://unifi.ui.com>Unifi portal</a>, select your UDMP then Settings > Networks > Add New Network and fill the form based on the config file.</p><p><img src=images/configUDMP1.png alt="UDMP Config page 1"></p><p><img src=images/configUDMP2.png alt="UDMP Config page 2"></p><p>In our case, we are not using Dynamic routing. Should you have a bigger and more complex network, this would be the way to go. Add the network and now your tunnel should be built once the UDMP sees traffic. You can ping your EC2 instance and check that everything works as planned. It will take few seconds for the connection to establish so be patient. You can also check the AWS console VPC > Virtual Private Network (VPN) > Site-to-Site VPN Connections and select your connection then go on the Tunnel Details tab. You will see one tunnel being up. Indeed, we have not configured a second tunnel which would be a good idea for a product environment for redundancy. Simply create a second network of type &ldquo;site-to-site&rdquo; with the other endpoint IP address documented in the config file and change the route distance to 40.</p><p><img src=images/s2s-tunnel-up.png alt="S2S VPN Tunnel Up"></p><p>My task on ECS/Fargate has the IP address 10.155.0.186 and I can send a request from the Raspberry Pi to this container. Mission accomplished!
<img src=images/curl-to-ECS-task.png alt="Curl to ECS task"></p><p>So now, let&rsquo;s try to make it the VPN connection from the Raspberry Pi itself. I removed the VPN config from the UDMP.</p><h2 id=site-to-site-vpn-with-raspberry-pi-and-strongswan>Site-to-Site VPN with Raspberry Pi and strongSwan</h2><p>In this section, we will exactly the same infrastructure on AWS, the main difference will be that the tunnels will be formed from the Raspberry Pi. For that, we are going to install a VPN client called <a href=https://strongswan.org/>strongSwan</a>.</p><p><img src=images/s2s-vpn-Pi-strongSwan.png alt="Diagram VPN from Pi"></p><p>I am going to reuse the previous setup on AWS and this time, I am going to download from the AWS console in VPC > Virtual Private Network (VPN) > Site-to-Site VPN Connections the configuration file customized for strongSwan.</p><p><img src=images/config-strongSwan.png alt="strongSwan config file"></p><p>We need now to configure our Pi and install strongSwan. <code>sudo apt-get install strongswan</code></p><p>Acknowledge the message that will be displayed and the installation will complete.
<img src=images/strongSwan-message.png alt="strongSwan message"></p><p>Then, just follow all the intructions from the configuration file. There is a long list of instructions but they are customized to your setup so don&rsquo;t be afraid, you are in good hands. I configured routing manually following steps 2# to #5. For some reasons, the script would not kick off automatically and I wanted to keep control on things anyway (you will see why towards the end&mldr;).</p><p>At the end of the process, you should see that both tunnels are up.</p><p><img src=images/pi-vpn-up.png alt="VPN UP"></p><p>Let&rsquo;s double check on the AWS console:
<img src=images/aws-console-tunnels-up.png alt="AWS VPN UP"></p><p>Let&rsquo;s try now to ping our ECS task from the Pi
<img src=images/pi-ping-down.png alt="Ping not working"></p><p>What? What&rsquo;s wrong? Tunnels are up and we know that the configuration on the AWS side worked previously. So we should expect it to work.
As we know, packets never lie so let&rsquo;s take a capture while the same ping runs in the background.</p><p><img src=images/capture-eth0.png alt="Capture eth0">
There are two things of interest. We can see traffic going in both directions and it seems that NAT Traversal (ipsec-nat-t) is enabled. So the tunnels seem fine.</p><p>Let&rsquo;s now look into the tunnels to understand what&rsquo;s going on. The ping still runs in the background.
<img src=images/capture-tunnel.png alt="Capture Tunnel">
We see that traffic goes in one direction only. But the source IP address is not what we would expect. It is the Tunnel1 interface&rsquo;s IP and in fact, it does make sense. The system uses the interface Tunnel1 to communicate with the VPC. However, the VPC network has no route to 169.254.70.58 and this is not routable.</p><p>Since, we enabled routing during the configuration with <code>net.ipv4.ip_forward = 1</code> in /etc/sysctl.conf (documented in the configuration file), let&rsquo;s test from another computer in our home LAN. This will confirm that our Pi is well connected via VPN to our VPC. I added a static route on my Mac to point towards the Pi for traffic destined to my AWS VPC: <code>sudo route -n add -net 10.155.0.0/24 10.0.1.69</code>.</p><p><img src=images/ping-from-mac.png alt="ping from Mac"></p><p>The ping shows that the end-to-end connectivity is working and the traceroute confirms traffic is routed via the Pi. So we have to deal with the internal routing of the Pi to fix our problem now. We are going to leverage <code>iptables</code> to force the traffic destined to our AWS VPC to use the Raspberry Pi&rsquo;s LAN IP address (<code>10.0.1.69</code>), when originating from the Pi itself. Indeed, I don&rsquo;t want that all my LAN devices are seen with the Raspberry Pi&rsquo;s IP address so I can keep control in my VPC. In the configuration file, in the section #2 Tunnel Configuration, I was given an IP range for each tunnel: <code>169.254.211.158/30</code> and <code>169.254.70.58/30</code>. I am going to use those range in my iptables rules to change the behavior.</p><p><code>sudo iptables -t nat -A POSTROUTING --destination 10.155.0.0/24 --source 169.254.70.58/30 -j SNAT --to-source 10.0.1.69</code></p><p><code>sudo iptables -t nat -A POSTROUTING --destination 10.155.0.0/24 --source 169.254.211.158/30 -j SNAT --to-source 10.0.1.69</code></p><p>Now I can reach to my ECS task on AWS from the Pi:
<img src=images/curl-success-pi.png alt="Succesful CURL from Pi"></p><p>We have now a fully functional VPN fron the Raspberry Pi that can be our local GW to the Cloud.</p><h2 id=conclusion--clean-up>Conclusion & clean-up</h2><p>In this article, we have explored different ways to connect your home network (and more specifically a Raspberry Pi) to AWS. I will write another post about the use of ZeroTier and Wireguard.
Don&rsquo;t forget to tear down your AWS environment. Since we used cdk to build the infrastructure, we can just use <code>cdk destroy</code> to rollback all the changes.</p></div><div class=after-post-tags><ul class=tags><li><a href=/tags/containers>Containers</a></li><li><a href=/tags/aws>AWS</a></li><li><a href=/tags/networking>Networking</a></li></ul></div><div class="row PageNavigation d-flex justify-content-between font-weight-bold"><a class="d-block col-md-6" href=https://rjourdan.com/aws-container-a2z-step1/>&#171; AWS Containers a2z - Step 1 Lightsail</a>
<a class="d-block col-md-6 text-lg-right" href=https://rjourdan.com/aws-container-a2z-intro/>AWS Containers a2z - Introduction &#187;</a><div class=clearfix></div></div></div></div></div><div class=container><div id=comments class="row justify-content-center mb-5"><div class=col-md-8></div></div></div></div></div><footer class=footer><div class=container><div class=row><div class="col-md-6 col-sm-6 text-center text-lg-left">&copy; Copyright Romain Jourdan - All rights reserved</div><div class="col-md-6 col-sm-6 text-center text-lg-right"><a href=https://rjourdan.com/disclaimer.html>Disclaimer</a></div></div></div></footer></div><script src=https://code.jquery.com/jquery-3.4.1.min.js></script>
<script src=https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js integrity=sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM crossorigin=anonymous></script>
<script src=/js/mediumish.js></script>
<script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "41fec0b311d0416d9d40333187ce6b34"}'></script></body></html>